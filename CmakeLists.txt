cmake_minimum_required(VERSION 3.10)
project(os C ASM)

SET(TOOLS_DIR ${CMAKE_SOURCE_DIR}/tools)
set(CMAKE_C_COMPILER ${TOOLS_DIR}/arm-none-eabi-gcc.exe)
set(CMAKE_ASM_COMPILER ${CMAKE_C_COMPILER})
set(CMAKE_OBJCOPY ${TOOLS_DIR}/arm-none-eabi-objcopy.exe)
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -mcpu=cortex-a7 -ffreestanding -O2 -Wall -Wextra")
set(CMAKE_ASM_FLAGS "${CMAKE_ASM_FLAGS} -mcpu=cortex-a7")
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -T ${CMAKE_SOURCE_DIR}/linker.ld -nostdlib")
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

include_directories(${CMAKE_SOURCE_DIR}/src)

file(GLOB SOURCES
    "${CMAKE_SOURCE_DIR}/src/*.c"
    "${CMAKE_SOURCE_DIR}/src/*.h"
    "${CMAKE_SOURCE_DIR}/src/*.s"
)

add_executable(os.elf ${SOURCES})

add_custom_command(
    TARGET os.elf POST_BUILD
    COMMAND ${CMAKE_OBJCOPY} -O binary os.elf os.bin
)
